<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Transaction Manager</title>
  <style>
    /* (Your existing CSS â€” unchanged) */
    body { font-family: sans-serif; margin: 20px; background:#fafafa; }
    /* ... (Truncated for brevity in preview) ... */
    /* Keep your existing styles here exactly as you had them */
  </style>
</head>
<body>
<div id="app">
  <!-- (Your existing HTML UIs: filters, tables, modals, etc.) -->
  <!-- I'll include the core DOM required for the script to run -->
  <div id="controls">
    <select id="date-range-preset">
      <option value="current_month">This Month</option>
      <option value="last_month">Last Month</option>
      <option value="all_time" selected>All Time</option>
      <option value="custom">Custom</option>
    </select>

    <div id="custom-date-range" style="display:none;">
      <label for="start-date">Start Date:</label>
      <input type="date" id="start-date" onchange="applyDateFilter()">
      <label for="end-date">End Date:</label>
      <input type="date" id="end-date" onchange="applyDateFilter()">
    </div>
  </div>

  <div id="transactions-list">
    <table>
      <thead>
        <tr>
          <th style="width: 8%;" class="sortable" data-sort-key="dateObj" onclick="sortTransactions('dateObj')">Date</th>
          <th style="width: 10%;">Credit Card</th>
          <th style="width: 20%;">Description</th>
          <th style="width: 10%;">Category</th>
          <th style="width: 8%;">Original Amount</th>
          <th style="width: 8%;">My Total</th>
          <th style="width: 16%;">Actions</th>
          <th style="width: 20%;">Notes</th>
        </tr>
      </thead>
      <tbody id="transactions-body"></tbody>
    </table>
  </div>

  <!-- Manual Transaction Modal (simplified markup for context) -->
  <div id="manualTransactionModal" class="modal" style="display:none;">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal('manualTransactionModal')">&times;</span>
      <h2>Add Manual Transaction</h2>
      <div class="modal-field">
        <label for="manual-date">Date</label>
        <input type="date" id="manual-date">
      </div>
      <div class="modal-field">
        <label for="manual-cc">Credit Card</label>
        <select id="manual-cc"></select>
      </div>
      <div class="modal-field">
        <label for="manual-desc">Description</label>
        <input type="text" id="manual-desc">
      </div>
      <div class="modal-field">
        <label for="manual-category">Category</label>
        <input type="text" id="manual-category">
      </div>
      <div class="modal-field">
        <label for="manual-original-amount">Original Amount ($)</label>
        <input type="number" id="manual-original-amount" step="0.01" oninput="handleManualAmountChange()">
      </div>
      <div class="modal-field">
        <label>Split Status</label>
        <div id="manual-split-buttons" class="action-buttons-grid">
          <button class="btn-split-half action-button" data-action="half" onclick="handleManualSplitAction('half')">Half</button>
          <button class="btn-full action-button" data-action="full" onclick="handleManualSplitAction('full')">Full</button>
          <button class="btn-split-custom action-button" data-action="custom" onclick="openManualCustomSplitModal()">Custom Split</button>
          <button class="btn-na action-button" data-action="na" onclick="handleManualSplitAction('na')">N/A</button>
        </div>
      </div>
      <div class="modal-field">
        <label for="manual-my-total">My Total ($)</label>
        <input type="number" id="manual-my-total" step="0.01" oninput="handleManualMyTotalInput()">
      </div>
      <div class="modal-field">
        <label for="manual-notes">Notes</label>
        <input type="text" id="manual-notes">
      </div>

      <div class="modal-buttons" id="manual-modal-action-buttons">
        <button onclick="saveManualTransaction()" class="btn-full" id="manual-save-btn">Save Transaction</button>
        <button onclick="closeModal('manualTransactionModal')" class="btn-na">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Custom Split Modal (simplified) -->
  <div id="customSplitModal" class="modal" style="display:none;">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal('customSplitModal')">&times;</span>
      <h2>Custom Split</h2>
      <div id="modal-date"></div>
      <div id="modal-description"></div>
      <div id="modal-category"></div>
      <div id="modal-original-amount"></div>

      <div>
        <label for="split-type">Split Type</label>
        <select id="split-type" onchange="toggleCustomPortionField()">
          <option value="even">Even</option>
          <option value="custom">Custom</option>
        </select>
      </div>
      <div id="custom-portion-field" style="display:none;">
        <label for="my-custom-portion">My Portion ($)</label>
        <input id="my-custom-portion" type="number" step="0.01">
      </div>
      <div>
        <label for="split-ways">Split Ways</label>
        <input id="split-ways" type="number" value="2" min="1">
      </div>

      <div class="modal-buttons">
        <button onclick="applyCustomSplit()" class="btn-full">Apply</button>
        <button onclick="closeModal('customSplitModal')" class="btn-na">Cancel</button>
      </div>
    </div>
  </div>

</div>

<script>
/* --------------------------
   Full Script (updated)
   -------------------------- */

/* === Constants & Globals === */
const CREDIT_CARD_OPTIONS = [
    'Unlimited 3993',
    'Sapphire 8906',
    'Target',
    'My CC',
    'Manual'
];
const SKIP_CC_SELECTION = 'OLD_DATA_AUTO_ASSIGN';
const MANUAL_ENTRY_ID = 0;

let transactions = [];
let displayedTransactions = [];
let uniqueCategories = new Set();
let fullOriginalTotal = 0;
let fullMyTotal = 0;
let currentTransactionIndex = null;
let editingTransactionIndex = null;
let currentManagingCategory = null;
let transactionIndexToSplit = null;

let transactionSort = { key: 'dateObj', direction: 'asc' };
let breakdownSort = { key: 'percentage', direction: 'desc' };

let filesToProcess = [];
let currentProcessingFile = null;
let importedFilesHistory = [];
let reassigningFileIndex = null;
let currentImportType = 'new';
let currentBreakdownData = [];


/* === Utility helpers === */
function parseDateInput(dateString) {
    if (!dateString) return null;
    // Keep local date midday to avoid timezone shifts
    const datePart = dateString.split('T')[0];
    const asIso = datePart + 'T12:00:00';
    const d = new Date(asIso);
    if (isNaN(d.getTime())) return null;
    return d;
}

function formatDate(dateString) {
    const date = parseDateInput(dateString);
    if (date === null) return dateString;
    const options = { year: 'numeric', month: 'short', day: 'numeric' };
    return date.toLocaleDateString('en-US', options);
}

function formatCurrency(amount) {
    return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
}

function updateTotalsDisplay() {
    const elOrig = document.getElementById('full-original-total');
    const elMy = document.getElementById('full-my-total');
    if (elOrig) elOrig.textContent = formatCurrency(fullOriginalTotal);
    if (elMy) elMy.textContent = formatCurrency(fullMyTotal);
}

/* === Sorting helpers === */
/**
 * Sorts displayedTransactions using transactionSort.key & transactionSort.direction
 * WITHOUT toggling or changing transactionSort.direction.
 */
function applyCurrentSort() {
    const key = transactionSort.key;
    const direction = transactionSort.direction;
    displayedTransactions.sort((a, b) => {
        const aVal = a[key];
        const bVal = b[key];
        let comparison = 0;
        if (key === 'dateObj') {
            const aTime = aVal ? aVal.getTime() : 0;
            const bTime = bVal ? bVal.getTime() : 0;
            comparison = aTime - bTime;
        } else if (typeof aVal === 'number' && typeof bVal === 'number') {
            comparison = aVal - bVal;
        } else {
            comparison = String(aVal || '').localeCompare(String(bVal || ''));
        }
        return direction === 'asc' ? comparison : -comparison;
    });
    updateSortIndicators('transactions-list', transactionSort);
}

/* Original sortTransactions behavior kept but unchanged for user interactive sorting.
   It toggles direction when a user clicks a header.
*/
function sortTransactions(key) {
    if (transactionSort.key === key) {
        transactionSort.direction = transactionSort.direction === 'asc' ? 'desc' : 'asc';
    } else {
        transactionSort.key = key;
        transactionSort.direction = key === 'dateObj' ? 'asc' : 'desc';
    }
    applyCurrentSort();
    renderTransactions();
}

function updateSortIndicators(listId, sortState) {
    document.querySelectorAll(`#${listId} th.sortable`).forEach(th => {
        th.classList.remove('asc', 'desc');
        if (th.dataset.sortKey === sortState.key) {
            th.classList.add(sortState.direction);
        }
    });
}

/* === Rebuild displayedTransactions while preserving sort direction and scroll === */
function rebuildDisplayedTransactionsKeepSort() {
    // Save scroll
    const scrollY = window.scrollY;

    // Rebuild displayedTransactions using the currently selected date filter
    const preset = document.getElementById('date-range-preset').value;
    const customRangeDiv = document.getElementById('custom-date-range');
    let startDate = null;
    let endDate = null;

    if (preset === 'custom') {
        customRangeDiv.style.display = 'flex';
        startDate = document.getElementById('start-date').value ? parseDateInput(document.getElementById('start-date').value) : null;
        endDate = document.getElementById('end-date').value ? parseDateInput(document.getElementById('end-date').value) : null;
        if (endDate) endDate.setHours(23,59,59,999);
    } else {
        customRangeDiv.style.display = 'none';
        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth();
        if (preset === 'current_month') {
            startDate = new Date(year, month, 1);
            endDate = new Date(year, month + 1, 0);
            endDate.setHours(23,59,59,999);
        } else if (preset === 'last_month') {
            startDate = new Date(year, month - 1, 1);
            endDate = new Date(year, month, 0);
            endDate.setHours(23,59,59,999);
        } else if (preset === 'all_time') {
            startDate = null;
            endDate = null;
        }
    }

    displayedTransactions = transactions.filter(t => {
        const date = t.dateObj;
        const isAllTime = !startDate && !endDate;
        if (!date) {
            return isAllTime;
        }
        const meetsStart = !startDate || date >= startDate;
        const meetsEnd = !endDate || date <= endDate;
        return meetsStart && meetsEnd;
    });

    // Apply the current sort (without toggling)
    applyCurrentSort();

    // Re-render and recalc totals/breakdown
    renderTransactions();
    calculateTotals();
    applyBreakdownFilter();

    // Restore scrollY
    window.scrollTo(0, scrollY);
}

/* === Core rendering & calculation === */
function renderTransactions() {
    const tbody = document.getElementById('transactions-body');
    tbody.innerHTML = '';

    if (displayedTransactions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#666;padding:20px;">No transactions match the current filter.</td></tr>';
        return;
    }

    displayedTransactions.forEach((t) => {
        const originalIndex = transactions.indexOf(t);
        const row = tbody.insertRow();
        row.dataset.originalIndex = originalIndex;

        // Date
        row.insertCell().textContent = formatDate(t.date);

        // CC, Description
        row.insertCell().textContent = t.creditCard;
        row.insertCell().textContent = t.description;

        // Category editable select
        const categoryCell = row.insertCell();
        categoryCell.innerHTML = `<select class="category-select" style="width:100%;" onchange="updateTransactionCategory(${originalIndex}, this.value)">
            ${renderCategorySelectOptions(t.category)}
        </select>`;

        // Amounts
        const originalCell = row.insertCell();
        originalCell.textContent = formatCurrency(t.originalAmount);
        originalCell.style.color = t.originalAmount < 0 ? 'black' : 'green';

        const myTotalCell = row.insertCell();
        myTotalCell.textContent = formatCurrency(t.myTotal);
        myTotalCell.style.color = t.myTotal < 0 ? 'black' : 'green';

        // Actions
        const actionCell = row.insertCell();
        actionCell.classList.add('actions');

        if (t.fileName === 'Manual Entry') {
            actionCell.innerHTML = `
                <div class="action-buttons-grid single-button">
                    <button class="btn-full" style="background-color:#2473BC!important;" onclick="openManualTransactionModal(${originalIndex})">View/Edit</button>
                </div>
            `;
        } else {
            actionCell.innerHTML = `
                <div class="action-buttons-grid">
                    <button class="btn-split-half action-button ${t.status === 'Half' || t.status === 'Split Half' ? 'applied' : ''}" onclick="applySplitAction(${originalIndex}, 'half')">Half</button>
                    <button class="btn-full action-button ${t.status === 'Full' ? 'applied' : ''}" onclick="applySplitAction(${originalIndex}, 'full')">Full</button>
                    <button class="btn-split-custom action-button ${t.status === 'Custom Split' ? 'applied' : ''}" onclick="openCustomSplitModal(${originalIndex})">Custom</button>
                    <button class="btn-na action-button ${t.status === 'N/A' ? 'applied' : ''}" onclick="applySplitAction(${originalIndex}, 'na')">N/A</button>
                </div>
            `;
        }

        // Notes
        const notesCell = row.insertCell();
        notesCell.innerHTML = `<input type="text" class="notes-input" value="${t.notes ? t.notes.replace(/"/g,'&quot;') : ''}" readonly>`;

        if (t.status === 'N/A') {
            row.classList.add('na-applied');
        }
    });
}

function calculateTotals() {
    const filteredTxns = displayedTransactions.filter(t => t.category !== 'My Payments');
    fullOriginalTotal = filteredTxns.reduce((acc, t) => acc + t.originalAmount, 0);
    fullMyTotal = filteredTxns.reduce((acc, t) => acc + t.myTotal, 0);
    updateTotalsDisplay();
}

/* === Category helpers === */
function reRenderCategoryDropdowns() {
    const selects = document.querySelectorAll('.category-select');
    selects.forEach(select => {
        const currentValue = select.value;
        select.innerHTML = renderCategorySelectOptions(currentValue);
        if (currentValue && select.querySelector(`option[value="${currentValue}"]`)) {
            select.value = currentValue;
        } else {
            select.value = 'Uncategorized';
        }
    });
}

function renderCategorySelectOptions(currentCategory) {
    let optionsHtml = '';
    const sortedCategories = Array.from(uniqueCategories).sort((a,b) => a.localeCompare(b));
    if (!uniqueCategories.has('Uncategorized')) {
        sortedCategories.unshift('Uncategorized');
    }
    sortedCategories.forEach(category => {
        const selected = category === currentCategory ? 'selected' : '';
        optionsHtml += `<option value="${category}" ${selected}>${category}</option>`;
    });
    return optionsHtml;
}

function updateTransactionCategory(index, newCategory) {
    if (index >= 0 && index < transactions.length) {
        transactions[index].category = newCategory;
        // Update unique categories set
        uniqueCategories.clear();
        transactions.forEach(t => { if (t.category) uniqueCategories.add(t.category); });
        // Rebuild displayed list while preserving sort/scroll
        rebuildDisplayedTransactionsKeepSort();
    }
}

/* === Split & Edit functions (UPDATED TO PRESERVE VIEW) === */
function applySplitAction(index, action) {
    if (index < 0 || index >= transactions.length) return;

    const t = transactions[index];
    const originalAmount = t.originalAmount;
    let newMyTotal = 0;
    let newStatus = '';

    if (action === 'half') {
        newMyTotal = originalAmount / 2;
        newStatus = 'Half';
    } else if (action === 'full') {
        newMyTotal = originalAmount;
        newStatus = 'Full';
    } else if (action === 'na') {
        newMyTotal = 0;
        newStatus = 'N/A';
    } else {
        return;
    }

    t.myTotal = newMyTotal;
    t.status = newStatus;

    // Rebuild visible list, keep sort & scroll position
    rebuildDisplayedTransactionsKeepSort();
}

function openCustomSplitModal(index) {
    transactionIndexToSplit = index;
    const t = transactions[index];
    if (!t) return;
    document.getElementById('modal-date').textContent = formatDate(t.date);
    document.getElementById('modal-description').textContent = t.description;
    document.getElementById('modal-category').textContent = t.category;
    document.getElementById('modal-original-amount').textContent = formatCurrency(t.originalAmount);
    document.getElementById('split-ways').value = 2;
    document.getElementById('split-type').value = 'even';
    document.getElementById('custom-portion-field').style.display = 'none';
    openModal('customSplitModal');
}

function toggleCustomPortionField() {
    const splitType = document.getElementById('split-type').value;
    const customPortionField = document.getElementById('custom-portion-field');
    if (splitType === 'custom') {
        customPortionField.style.display = 'block';
        document.getElementById('my-custom-portion').value = '';
    } else {
        customPortionField.style.display = 'none';
    }
}

function applyCustomSplit() {
    if (transactionIndexToSplit === null) return;
    const splitType = document.getElementById('split-type').value;
    const t = transactions[transactionIndexToSplit];
    if (!t) return;
    const originalAmount = t.originalAmount;
    let newMyTotal = 0;

    if (splitType === 'even') {
        const splitWays = parseInt(document.getElementById('split-ways').value);
        if (isNaN(splitWays) || splitWays <= 0) {
            alert('Please enter a valid number of ways to split.');
            return;
        }
        newMyTotal = originalAmount / splitWays;
    } else if (splitType === 'custom') {
        const customPortion = parseFloat(document.getElementById('my-custom-portion').value);
        if (isNaN(customPortion)) {
            alert('Please enter a valid custom portion for your total.');
            return;
        }
        if (Math.abs(customPortion) > Math.abs(originalAmount) && originalAmount !== 0) {
            if (!confirm(`Your custom portion (${formatCurrency(customPortion)}) is greater than the original amount (${formatCurrency(originalAmount)}). Do you want to continue?`)) {
                return;
            }
        }
        newMyTotal = customPortion;
    }

    t.myTotal = newMyTotal;
    t.status = 'Custom Split';

    closeModal('customSplitModal');

    rebuildDisplayedTransactionsKeepSort();
}

/* === Manual transaction modal (save/delete) - UPDATED === */
function openManualTransactionModal(index = null) {
    const modal = document.getElementById('manualTransactionModal');
    const isEditing = index !== null;
    editingTransactionIndex = index;

    reRenderCategoryDropdowns();
    document.getElementById('manual-original-amount').disabled = false;
    document.getElementById('manual-my-total').disabled = false;

    const actionButtonsContainer = document.getElementById('manual-modal-action-buttons');
    const existingDeleteButton = document.getElementById('manual-delete-btn');
    if (existingDeleteButton) existingDeleteButton.remove();

    if (isEditing) {
        modal.querySelector('h2').textContent = 'Edit Transaction';
        modal.dataset.context = 'edit';
        const t = transactions[index];
        document.getElementById('manual-date').value = t.date;
        document.getElementById('manual-cc').value = t.creditCard;
        document.getElementById('manual-desc').value = t.description;
        document.getElementById('manual-category').value = t.category || '';
        document.getElementById('manual-original-amount').value = t.originalAmount;
        document.getElementById('manual-my-total').value = t.myTotal;
        document.getElementById('manual-notes').value = t.notes || '';

        document.querySelectorAll('#manual-split-buttons button').forEach(btn => btn.classList.remove('applied'));
        if (t.status === 'Half' || t.status === 'Split Half') {
            modal.querySelector('[data-action="half"]').classList.add('applied');
        } else if (t.status === 'Full') {
            modal.querySelector('[data-action="full"]').classList.add('applied');
        } else if (t.status === 'Custom Split') {
            modal.querySelector('[data-action="custom"]').classList.add('applied');
        } else if (t.status === 'N/A') {
            modal.querySelector('[data-action="na"]').classList.add('applied');
        }

        if (t.status === 'Full') {
            document.getElementById('manual-my-total').value = t.originalAmount;
            document.getElementById('manual-my-total').disabled = true;
        } else if (t.status === 'Half' || t.status === 'Split Half') {
            document.getElementById('manual-my-total').value = (t.originalAmount / 2).toFixed(2);
            document.getElementById('manual-my-total').disabled = true;
        } else if (t.status === 'N/A') {
            document.getElementById('manual-my-total').value = 0;
            document.getElementById('manual-my-total').disabled = true;
        } else {
            document.getElementById('manual-my-total').disabled = false;
        }

        const deleteButton = document.createElement('button');
        deleteButton.id = 'manual-delete-btn';
        deleteButton.classList.add('btn-delete');
        deleteButton.textContent = 'Delete Transaction';
        deleteButton.onclick = () => { deleteTransaction(index); closeModal('manualTransactionModal'); };
        const cancelButton = actionButtonsContainer.querySelector('.btn-na');
        actionButtonsContainer.insertBefore(deleteButton, cancelButton);
    } else {
        modal.querySelector('h2').textContent = 'Add Manual Transaction';
        modal.dataset.context = 'add';
        document.getElementById('manual-date').valueAsDate = new Date();
        document.getElementById('manual-cc').value = CREDIT_CARD_OPTIONS[CREDIT_CARD_OPTIONS.length - 1];
        document.getElementById('manual-desc').value = '';
        document.getElementById('manual-category').value = '';
        document.getElementById('manual-original-amount').value = '';
        document.getElementById('manual-my-total').value = '';
        document.getElementById('manual-notes').value = '';
        document.querySelectorAll('#manual-split-buttons button').forEach(btn => { btn.classList.remove('applied'); });
    }
    openModal('manualTransactionModal');
}

function saveManualTransaction() {
    const date = document.getElementById('manual-date').value;
    const creditCard = document.getElementById('manual-cc').value;
    const description = document.getElementById('manual-desc').value.trim();
    const category = document.getElementById('manual-category').value.trim();
    const originalAmountStr = document.getElementById('manual-original-amount').value;
    const myTotalStr = document.getElementById('manual-my-total').value;
    const notes = document.getElementById('manual-notes').value.trim();

    if
